<!-- templates/books/detail.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ book.title }} - مكتبة الكتب{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
    <!-- مسار التنقل -->
    <div class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center text-sm text-gray-600">
                <a href="{% url 'home' %}" class="hover:text-blue-600">الرئيسية</a>
                <i class="fas fa-chevron-left mx-2"></i>
                <a href="{% url 'book_list' %}" class="hover:text-blue-600">الكتب</a>
                <i class="fas fa-chevron-left mx-2"></i>
                <a href="{% url 'books_by_category' book.category.slug %}" class="hover:text-blue-600">{{ book.category.name }}</a>
                <i class="fas fa-chevron-left mx-2"></i>
                <span class="text-gray-800 font-medium">{{ book.title|truncatechars:30 }}</span>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- معلومات الكتاب الرئيسية -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 animate-on-scroll">
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- صورة الكتاب -->
                <div class="lg:w-1/3">
                    <div class="book-cover-container relative">
                        {% if book.cover_image %}
                        <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" 
                             class="w-full rounded-2xl shadow-xl transform hover:rotate-1 transition duration-500">
                        {% else %}
                        <div class="w-full h-96 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-2xl shadow-xl flex items-center justify-center">
                            <i class="fas fa-book-open text-9xl text-blue-300"></i>
                        </div>
                        {% endif %}
                        
                        <!-- العلامات -->
                        <div class="absolute top-4 right-4 flex flex-col space-y-2">
                            {% if book.is_free %}
                            <span class="bg-green-500 text-white px-4 py-2 rounded-full font-bold shadow-lg">
                                مجاني
                            </span>
                            {% endif %}
                            {% if book.is_featured %}
                            <span class="bg-yellow-500 text-white px-4 py-2 rounded-full font-bold shadow-lg">
                                مميز
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- شريط التقدم (إذا كان المستخدم يقرأ الكتاب) -->
                        {% if reading_progress %}
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4">
                            <div class="text-white">
                                <div class="flex justify-between text-sm mb-2">
                                    <span>تقدم القراءة</span>
                                    <span>{{ reading_progress.progress }}%</span>
                                </div>
                                <div class="w-full bg-white/30 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: {{ reading_progress.progress }}%"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- إحصائيات الكتاب -->
                    <div class="mt-6 grid grid-cols-3 gap-4">
                        <div class="bg-blue-50 rounded-xl p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600 mb-1">{{ book.average_rating|floatformat:1 }}</div>
                            <div class="text-sm text-gray-600">التقييم</div>
                        </div>
                        <div class="bg-green-50 rounded-xl p-4 text-center">
                            <div class="text-2xl font-bold text-green-600 mb-1">{{ book.reviews.count }}</div>
                            <div class="text-sm text-gray-600">مراجعة</div>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600 mb-1">{{ book.pages }}</div>
                            <div class="text-sm text-gray-600">صفحة</div>
                        </div>
                    </div>
                </div>
                
                <!-- تفاصيل الكتاب -->
                <div class="lg:w-2/3">
                    <!-- العنوان والمؤلف -->
                    <div class="mb-6">
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">{{ book.title }}</h1>
                        <div class="flex items-center flex-wrap gap-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center ml-3">
                                    <i class="fas fa-user-pen text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="text-gray-600">المؤلف</p>
                                    <p class="font-medium text-gray-800">{{ book.author }}</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center ml-3">
                                    <i class="fas fa-tags text-green-600"></i>
                                </div>
                                <div>
                                    <p class="text-gray-600">التصنيف</p>
                                    <p class="font-medium text-gray-800">{{ book.category.name }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- التقييم -->
                    <div class="mb-6">
                        <div class="flex items-center mb-4">
                            <div class="flex">
                                {% with avg_rating=book.average_rating %}
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= avg_rating|add:"0"|floatformat:"0"|add:"0" %}
                                    <i class="fas fa-star text-yellow-500 text-xl"></i>
                                    {% elif forloop.counter == avg_rating|add:"0.5"|floatformat:"0"|add:"0" and avg_rating|floatformat:1|slice:"-1" == "5" %}
                                    <i class="fas fa-star-half-alt text-yellow-500 text-xl"></i>
                                    {% else %}
                                    <i class="far fa-star text-yellow-500 text-xl"></i>
                                    {% endif %}
                                {% endfor %}
                                <span class="mr-4 text-xl font-bold text-gray-800">{{ avg_rating|floatformat:1 }}</span>
                                <span class="text-gray-600">({{ book.reviews.count }} تقييم)</span>
                                {% endwith %}
                            </div>
                        </div>
                        
                        {% if not user_review %}
                        <button id="add-review-btn" class="text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-star ml-2"></i> أضف تقييمك
                        </button>
                        {% endif %}
                    </div>
                    
                    <!-- الوصف -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">عن الكتاب</h3>
                        <div class="prose prose-lg max-w-none">
                            <p class="text-gray-600 leading-relaxed">{{ book.description }}</p>
                        </div>
                    </div>
                    
                    <!-- معلومات إضافية -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">معلومات الكتاب</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-gray-600 text-sm mb-1">سنة النشر</p>
                                <p class="font-medium text-gray-800">{{ book.published_year }}</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-gray-600 text-sm mb-1">عدد الصفحات</p>
                                <p class="font-medium text-gray-800">{{ book.pages }}</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-gray-600 text-sm mb-1">اللغة</p>
                                <p class="font-medium text-gray-800">{{ book.language }}</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-gray-600 text-sm mb-1">التنسيق</p>
                                <p class="font-medium text-gray-800">{{ book.file_format }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- أزرار الإجراء -->
                    <div class="flex flex-wrap gap-4">
                        {% if book.is_free %}
                        <a href="#" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl text-center transition duration-300 transform hover:-translate-y-1">
                            <i class="fas fa-download ml-2"></i> تحميل الكتاب
                        </a>
                        {% else %}
                        <a href="#" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl text-center transition duration-300 transform hover:-translate-y-1">
                            <i class="fas fa-shopping-cart ml-2"></i> شراء الآن ({{ book.price }} ريال)
                        </a>
                        {% endif %}
                        
                        <button class="read-btn bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-bold py-4 px-6 rounded-xl transition duration-300">
                            <i class="fas fa-book-open ml-2"></i> ابدأ القراءة
                        </button>
                        
                        {% if user.is_authenticated %}
                        <button class="bookmark-detail-btn p-4 border-2 border-gray-300 rounded-xl hover:border-yellow-500 hover:bg-yellow-50 transition duration-300"
                                data-book-id="{{ book.id }}">
                            <i class="fas fa-bookmark {% if is_bookmarked %}text-yellow-500{% else %}text-gray-400{% endif %}"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- التقييمات والمراجعات -->
            <div class="lg:col-span-2">
                <!-- قسم التقييمات -->
                <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 animate-on-scroll">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-2xl font-bold text-gray-800">التقييمات والمراجعات</h3>
                        <div class="flex items-center">
                            <span class="text-gray-600 mr-4">التقييم العام</span>
                            <div class="text-3xl font-bold text-gray-800">{{ book.average_rating|floatformat:1 }}</div>
                        </div>
                    </div>
                    
<!-- توزيع التقييمات -->
<div class="mb-8">
    {% for item in ratings_data %}
    <div class="flex items-center mb-3">
        <span class="w-10 text-gray-600">{{ item.stars }} نجوم</span>

        <div class="flex-1 mx-4">
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-yellow-500 h-2 rounded-full transition-all duration-500"
                     style="width:
                     {% if total_reviews %}
                         {% widthratio item.count total_reviews 100 %}
                     {% else %}
                         0
                     {% endif %}%">
                </div>
            </div>
        </div>

        <span class="w-10 text-gray-600 text-right">
            {{ item.count }}
        </span>
    </div>
    {% endfor %}                    
                    <!-- نموذج إضافة تقييم -->
                    {% if user.is_authenticated and not user_review %}
                    <div id="review-form-container" class="hidden">
                        <form method="POST" action="{% url 'add_review' book.id %}" class="space-y-4 mb-8">
                            {% csrf_token %}
                            <h4 class="text-lg font-bold text-gray-800 mb-4">أضف تقييمك</h4>
                            
                            <!-- تقييم النجوم -->
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">تقييمك</label>
                                <div class="rating-stars flex space-x-2 space-x-reverse">
                                    {% for i in "12345"|make_list %}
                                    <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" class="hidden" 
                                           {% if forloop.last %}checked{% endif %}>
                                    <label for="star{{ i }}" class="text-3xl cursor-pointer text-gray-300 hover:text-yellow-400">
                                        <i class="fas fa-star"></i>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- التعليق -->
                            <div>
                                <label class="block text-gray-700 mb-2">مراجعتك</label>
                                <textarea name="comment" rows="4" 
                                          class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          placeholder="شاركنا رأيك في هذا الكتاب..."></textarea>
                            </div>
                            
                            <div class="flex justify-end space-x-4">
                                <button type="button" id="cancel-review" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">
                                    إلغاء
                                </button>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                                    <i class="fas fa-paper-plane ml-2"></i> نشر التقييم
                                </button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                    
                    <!-- قائمة التقييمات -->
                    <div>
                        {% if reviews %}
                        <div class="space-y-6">
                            {% for review in reviews %}
                            <div class="review-item border-t border-gray-100 pt-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center ml-4">
                                            <i class="fas fa-user text-blue-600"></i>
                                        </div>
                                        <div>
                                            <h5 class="font-bold text-gray-800">{{ review.user.username }}</h5>
                                            <p class="text-sm text-gray-500">{{ review.created_at|timesince }}</p>
                                        </div>
                                    </div>
                                    <div class="flex">
                                        {% for i in "12345"|make_list %}
                                            {% if forloop.counter <= review.rating %}
                                            <i class="fas fa-star text-yellow-500"></i>
                                            {% else %}
                                            <i class="far fa-star text-yellow-500"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <p class="text-gray-600">{{ review.comment }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- تحميل المزيد -->
                        {% if reviews.count > 3 %}
                        <div class="mt-8 text-center">
                            <button id="load-more-reviews" class="text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-arrow-down ml-2"></i> عرض المزيد من التقييمات
                            </button>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-star text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-600">لا توجد تقييمات بعد. كن أول من يقيم هذا الكتاب!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- كتب مشابهة -->
                <div class="bg-white rounded-2xl shadow-lg p-8 animate-on-scroll">
                    <h3 class="text-2xl font-bold text-gray-800 mb-8">كتب مشابهة</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for similar_book in similar_books %}
                        <a href="{% url 'book_detail' similar_book.slug %}" class="similar-book group">
                            <div class="bg-gray-50 rounded-xl p-4 hover:bg-blue-50 transition duration-300">
                                <div class="flex items-start">
                                    <div class="w-16 h-20 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg flex items-center justify-center ml-4">
                                        {% if similar_book.cover_image %}
                                        <img src="{{ similar_book.cover_image.url }}" alt="{{ similar_book.title }}" 
                                             class="w-full h-full object-cover rounded-lg">
                                        {% else %}
                                        <i class="fas fa-book text-blue-300"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-800 group-hover:text-blue-600 mb-1">{{ similar_book.title|truncatechars:25 }}</h4>
                                        <p class="text-gray-600 text-sm mb-2">{{ similar_book.author }}</p>
                                        <div class="flex items-center">
                                            {% with avg_rating=similar_book.average_rating %}
                                            {% for i in "12345"|make_list %}
                                                {% if forloop.counter <= avg_rating|add:"0"|floatformat:"0"|add:"0" %}
                                                <i class="fas fa-star text-yellow-500 text-xs"></i>
                                                {% else %}
                                                <i class="far fa-star text-yellow-500 text-xs"></i>
                                                {% endif %}
                                            {% endfor %}
                                            <span class="text-xs text-gray-600 mr-2">{{ avg_rating|floatformat:1 }}</span>
                                            {% endwith %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                        {% empty %}
                        <div class="col-span-3 text-center py-8">
                            <p class="text-gray-600">لا توجد كتب مشابهة حالياً</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- الشريط الجانبي -->
            <div class="space-y-8">
                <!-- معلومات المؤلف -->
                <div class="bg-white rounded-2xl shadow-lg p-6 animate-on-scroll">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">عن المؤلف</h4>
                    <div class="flex items-start mb-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center ml-4">
                            <i class="fas fa-user-pen text-purple-600"></i>
                        </div>
                        <div>
                            <h5 class="font-bold text-gray-800">{{ book.author }}</h5>
                            <p class="text-sm text-gray-600">مؤلف</p>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm">
                        {{ book.author }} هو مؤلف هذا الكتاب. يمكنك الاطلاع على كتب أخرى له في هذا القسم.
                    </p>
                </div>
                
                <!-- إحصائيات القراءة -->
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl shadow-lg p-6 animate-on-scroll">
                    <h4 class="text-lg font-bold mb-4">إحصائيات القراءة</h4>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-blue-100">عدد القراء</span>
                                <span class="font-bold">1,248</span>
                            </div>
                            <div class="w-full bg-white/20 rounded-full h-2">
                                <div class="bg-white h-2 rounded-full" style="width: 75%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-blue-100">متوسط وقت القراءة</span>
                                <span class="font-bold">4.2 ساعة</span>
                            </div>
                            <div class="w-full bg-white/20 rounded-full h-2">
                                <div class="bg-white h-2 rounded-full" style="width: 60%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-blue-100">نسبة الإكمال</span>
                                <span class="font-bold">68%</span>
                            </div>
                            <div class="w-full bg-white/20 rounded-full h-2">
                                <div class="bg-white h-2 rounded-full" style="width: 68%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- معلومات إضافية -->
                <div class="bg-white rounded-2xl shadow-lg p-6 animate-on-scroll">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">معلومات إضافية</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">تاريخ النشر</span>
                            <span class="font-medium text-gray-800">{{ book.published_year }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">اللغة</span>
                            <span class="font-medium text-gray-800">{{ book.language }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">التنسيق</span>
                            <span class="font-medium text-gray-800">{{ book.file_format }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">رقم التصنيف</span>
                            <span class="font-medium text-gray-800">ISBN-{{ book.id|stringformat:"010d" }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- مشاركة الكتاب -->
                <div class="bg-white rounded-2xl shadow-lg p-6 animate-on-scroll">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">شارك الكتاب</h4>
                    <div class="flex space-x-3">
                        <button class="share-btn bg-blue-100 text-blue-600 p-3 rounded-full hover:bg-blue-200 transition duration-300">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button class="share-btn bg-blue-400 text-white p-3 rounded-full hover:bg-blue-500 transition duration-300">
                            <i class="fab fa-twitter"></i>
                        </button>
                        <button class="share-btn bg-red-100 text-red-600 p-3 rounded-full hover:bg-red-200 transition duration-300">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="share-btn bg-gray-800 text-white p-3 rounded-full hover:bg-gray-900 transition duration-300">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- نموذج قراءة الكتاب -->
<div id="reading-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800">قارئ الكتب</h3>
            <button id="close-reading-modal" class="text-gray-500 hover:text-gray-700 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-6 h-[calc(90vh-80px)] overflow-y-auto">
            <!-- محتوى الكتاب -->
            <div class="prose prose-lg max-w-none">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">{{ book.title }}</h2>
                <h3 class="text-xl text-gray-600 mb-8">بواسطة {{ book.author }}</h3>
                
                <div class="text-gray-700 leading-relaxed text-lg">
                    <!-- محتوى الكتاب سيتم تحميله هنا -->
                    {{ book.description|linebreaks }}
                    <p class="mt-8 text-center text-gray-500">
                        هذا نموذج لعرض محتوى الكتاب. في التطبيق الحقيقي، سيتم تحميل المحتوى الكامل للكتاب هنا.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="border-t border-gray-200 p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <button class="p-2 text-gray-600 hover:text-gray-800">
                        <i class="fas fa-font"></i>
                    </button>
                    <button class="p-2 text-gray-600 hover:text-gray-800">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="p-2 text-gray-600 hover:text-gray-800">
                        <i class="fas fa-bookmark"></i>
                    </button>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        الصفحة <span id="current-page">1</span> من <span id="total-pages">100</span>
                    </div>
                    <div class="flex space-x-2">
                        <button class="p-2 text-gray-600 hover:text-gray-800">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button class="p-2 text-gray-600 hover:text-gray-800">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // تأثيرات GSAP لتفاصيل الكتاب
    document.addEventListener('DOMContentLoaded', function() {
        // تأثيرات ظهور العناصر
        const animatedElements = document.querySelectorAll('.animate-on-scroll');
        animatedElements.forEach((el, index) => {
            gsap.from(el, {
                opacity: 0,
                y: 30,
                duration: 0.6,
                delay: index * 0.1,
                scrollTrigger: {
                    trigger: el,
                    start: "top 85%",
                    toggleActions: "play none none none"
                }
            });
        });
        
        // تأثير على غلاف الكتاب
        const bookCover = document.querySelector('.book-cover-container img');
        if (bookCover) {
            bookCover.addEventListener('mouseenter', function() {
                gsap.to(this, {
                    scale: 1.05,
                    duration: 0.3
                });
            });
            
            bookCover.addEventListener('mouseleave', function() {
                gsap.to(this, {
                    scale: 1,
                    duration: 0.3
                });
            });
        }
        
        // تأثيرات على أزرار الإجراء
        const actionButtons = document.querySelectorAll('.read-btn, a[href*="download"], a[href*="cart"]');
        actionButtons.forEach(btn => {
            btn.addEventListener('mouseenter', function() {
                gsap.to(this, {
                    y: -3,
                    duration: 0.2
                });
            });
            
            btn.addEventListener('mouseleave', function() {
                gsap.to(this, {
                    y: 0,
                    duration: 0.2
                });
            });
        });
        
        // إضافة تقييم
        const addReviewBtn = document.getElementById('add-review-btn');
        const reviewFormContainer = document.getElementById('review-form-container');
        const cancelReviewBtn = document.getElementById('cancel-review');
        const ratingStars = document.querySelectorAll('.rating-stars label');
        
        if (addReviewBtn && reviewFormContainer) {
            addReviewBtn.addEventListener('click', function() {
                reviewFormContainer.classList.remove('hidden');
                gsap.from(reviewFormContainer, {
                    opacity: 0,
                    y: 20,
                    duration: 0.3
                });
                
                // تأثير على الزر
                gsap.fromTo(this,
                    { scale: 1 },
                    { scale: 0.95, duration: 0.1, yoyo: true, repeat: 1 }
                );
            });
        }
        
        if (cancelReviewBtn && reviewFormContainer) {
            cancelReviewBtn.addEventListener('click', function() {
                gsap.to(reviewFormContainer, {
                    opacity: 0,
                    y: -20,
                    duration: 0.3,
                    onComplete: () => {
                        reviewFormContainer.classList.add('hidden');
                    }
                });
            });
        }
        
        // تأثيرات على نجوم التقييم
        ratingStars.forEach((star, index) => {
            star.addEventListener('mouseenter', function() {
                const stars = document.querySelectorAll('.rating-stars label');
                stars.forEach((s, i) => {
                    if (i <= index) {
                        gsap.to(s, {
                            color: '#fbbf24',
                            duration: 0.2
                        });
                    }
                });
            });
            
            star.addEventListener('mouseleave', function() {
                const stars = document.querySelectorAll('.rating-stars label');
                const checkedInput = document.querySelector('.rating-stars input:checked');
                const checkedIndex = checkedInput ? parseInt(checkedInput.value) - 1 : 4;
                
                stars.forEach((s, i) => {
                    if (i <= checkedIndex) {
                        gsap.to(s, {
                            color: '#fbbf24',
                            duration: 0.2
                        });
                    } else {
                        gsap.to(s, {
                            color: '#d1d5db',
                            duration: 0.2
                        });
                    }
                });
            });
            
            star.addEventListener('click', function() {
                const input = this.previousElementSibling;
                const stars = document.querySelectorAll('.rating-stars label');
                
                stars.forEach((s, i) => {
                    if (i <= index) {
                        gsap.to(s, {
                            color: '#fbbf24',
                            scale: 1.1,
                            duration: 0.2,
                            yoyo: true,
                            repeat: 1
                        });
                    } else {
                        gsap.to(s, {
                            color: '#d1d5db',
                            duration: 0.2
                        });
                    }
                });
            });
        });
        
        // تحميل المزيد من التقييمات
        const loadMoreReviewsBtn = document.getElementById('load-more-reviews');
        if (loadMoreReviewsBtn) {
            loadMoreReviewsBtn.addEventListener('click', function() {
                // تأثير على الزر
                gsap.fromTo(this,
                    { scale: 1 },
                    { scale: 0.95, duration: 0.1, yoyo: true, repeat: 1 }
                );
                
                // محاكاة تحميل المزيد من التقييمات
                setTimeout(() => {
                    const newReview = document.createElement('div');
                    newReview.className = 'review-item border-t border-gray-100 pt-6';
                    newReview.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center ml-4">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                                <div>
                                    <h5 class="font-bold text-gray-800">مستخدم جديد</h5>
                                    <p class="text-sm text-gray-500">الآن</p>
                                </div>
                            </div>
                            <div class="flex">
                                <i class="fas fa-star text-yellow-500"></i>
                                <i class="fas fa-star text-yellow-500"></i>
                                <i class="fas fa-star text-yellow-500"></i>
                                <i class="fas fa-star text-yellow-500"></i>
                                <i class="far fa-star text-yellow-500"></i>
                            </div>
                        </div>
                        <p class="text-gray-600">هذا تقييم إضافي تم تحميله ديناميكياً.</p>
                    `;
                    
                    const lastReview = document.querySelector('.review-item:last-child');
                    lastReview.parentNode.insertBefore(newReview, lastReview.nextSibling);
                    
                    // تأثير ظهور التقييم الجديد
                    gsap.from(newReview, {
                        opacity: 0,
                        y: 20,
                        duration: 0.5
                    });
                }, 500);
            });
        }
        
        // إضافة/إزالة من المفضلة
        const bookmarkBtn = document.querySelector('.bookmark-detail-btn');
        if (bookmarkBtn) {
            bookmarkBtn.addEventListener('click', function() {
                const bookId = this.getAttribute('data-book-id');
                const icon = this.querySelector('i');
                
                // تغيير الحالة
                if (icon.classList.contains('text-yellow-500')) {
                    icon.classList.remove('text-yellow-500');
                    icon.classList.add('text-gray-400');
                    this.classList.remove('border-yellow-500', 'bg-yellow-50');
                    this.classList.add('border-gray-300');
                } else {
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-yellow-500');
                    this.classList.remove('border-gray-300');
                    this.classList.add('border-yellow-500', 'bg-yellow-50');
                }
                
                // تأثير GSAP
                gsap.fromTo(this,
                    { scale: 1 },
                    { scale: 1.2, duration: 0.2, yoyo: true, repeat: 1 }
                );
                
                // إرسال طلب AJAX
                fetch(`/books/${bookId}/bookmark/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    }
                }).then(response => {
                    // معالجة الاستجابة
                });
            });
        }
        
        // فتح قارئ الكتب
        const readBtn = document.querySelector('.read-btn');
        const readingModal = document.getElementById('reading-modal');
        const closeReadingModal = document.getElementById('close-reading-modal');
        
        if (readBtn && readingModal) {
            readBtn.addEventListener('click', function() {
                readingModal.classList.remove('hidden');
                gsap.fromTo(readingModal,
                    { opacity: 0 },
                    { opacity: 1, duration: 0.3 }
                );
                
                const modalContent = readingModal.querySelector('.bg-white');
                gsap.fromTo(modalContent,
                    { scale: 0.9, opacity: 0 },
                    { scale: 1, opacity: 1, duration: 0.4 }
                );
            });
        }
        
        if (closeReadingModal && readingModal) {
            closeReadingModal.addEventListener('click', function() {
                const modalContent = readingModal.querySelector('.bg-white');
                gsap.to(modalContent, {
                    scale: 0.9,
                    opacity: 0,
                    duration: 0.3,
                    onComplete: () => {
                        readingModal.classList.add('hidden');
                    }
                });
                
                gsap.to(readingModal, {
                    opacity: 0,
                    duration: 0.3
                });
            });
        }
        
        // مشاركة الكتاب
        const shareBtns = document.querySelectorAll('.share-btn');
        shareBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // تأثير على الزر
                gsap.fromTo(this,
                    { scale: 1 },
                    { scale: 0.9, duration: 0.1, yoyo: true, repeat: 1 }
                );
                
                // عرض رسالة التأكيد
                const message = document.createElement('div');
                message.className = 'fixed bottom-4 right-4 bg-green-50 border border-green-200 text-green-700 px-6 py-4 rounded-lg shadow-lg z-50';
                message.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 ml-3"></i>
                        <div>
                            <p class="font-bold">تم النسخ</p>
                            <p class="text-sm">تم نسخ رابط الكتاب إلى الحافظة</p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(message);
                
                // تأثير ظهور الرسالة
                gsap.from(message, {
                    opacity: 0,
                    y: 20,
                    duration: 0.3
                });
                
                // إزالة الرسالة بعد 3 ثواني
                setTimeout(() => {
                    gsap.to(message, {
                        opacity: 0,
                        y: 20,
                        duration: 0.3,
                        onComplete: () => {
                            message.remove();
                        }
                    });
                }, 3000);
                
                // نسخ الرابط إلى الحافظة
                navigator.clipboard.writeText(window.location.href);
            });
        });
        
        // تأثيرات على الكتب المشابهة
        const similarBooks = document.querySelectorAll('.similar-book');
        similarBooks.forEach(book => {
            book.addEventListener('mouseenter', function() {
                gsap.to(this, {
                    y: -5,
                    duration: 0.2
                });
            });
            
            book.addEventListener('mouseleave', function() {
                gsap.to(this, {
                    y: 0,
                    duration: 0.2
                });
            });
        });
        
        // تأثيرات على إحصائيات القراءة
        const progressBars = document.querySelectorAll('.bg-gradient-to-r .bg-white');
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            
            gsap.to(bar, {
                width: width,
                duration: 1.5,
                delay: 0.5,
                ease: "power2.out"
            });
        });
        
        // تأثيرات على إحصائيات الكتاب
        const statCards = document.querySelectorAll('.bg-blue-50, .bg-green-50, .bg-purple-50');
        statCards.forEach((card, index) => {
            gsap.from(card, {
                scale: 0.8,
                opacity: 0,
                duration: 0.5,
                delay: index * 0.1
            });
        });
        
        // تأثير على شريط التقدم
        const readingProgressBar = document.querySelector('.bg-green-500');
        if (readingProgressBar) {
            const width = readingProgressBar.style.width;
            readingProgressBar.style.width = '0%';
            
            gsap.to(readingProgressBar, {
                width: width,
                duration: 1.5,
                delay: 0.2,
                ease: "power2.out"
            });
        }
    });
</script>
{% endblock %}
{% endblock %}